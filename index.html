<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>不動産契約進捗管理（スタンドアロン）</title>

  <!-- React 18 UMD -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Babel (ブラウザでJSX変換用) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- TailwindCSS（CDN） -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>

  <style>
    body { background: #f7fafc; font-feature-settings: "palt" 1; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // ====== lucide-react の代替：簡易SVGアイコン ======
    const makeIcon = (label) => ({ className = "w-5 h-5", ...rest }) => (
      <svg
        className={className}
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        aria-label={label}
        {...rest}
      >
        <rect x="3" y="3" width="18" height="18" rx="4" ry="4"></rect>
        <text x="12" y="15" textAnchor="middle" fontSize="8" fontFamily="sans-serif">
          {label?.[0] || "I"}
        </text>
      </svg>
    );

    const Bell = makeIcon('Bell');
    const Plus = makeIcon('Plus');
    const X = makeIcon('X');
    const Calendar = makeIcon('Cal');
    const User = makeIcon('User');
    const Building2 = makeIcon('Bld');
    const AlertCircle = makeIcon('!');
    const Check = makeIcon('OK');
    const Clock = makeIcon('Clk');
    const ChevronRight = makeIcon('>');
    const Users = makeIcon('Usr');
    const MapPin = makeIcon('Pin');
    const Briefcase = makeIcon('Job');
    const DollarSign = makeIcon('¥');
    const FileText = makeIcon('Doc');
    const Upload = makeIcon('Up');
    const TrendingUp = makeIcon('UpT');
    const BarChart3 = makeIcon('Bar');
    const Search = makeIcon('Srch');
    const Filter = makeIcon('Fltr');
    const Download = makeIcon('DL');
    const Edit2 = makeIcon('Edt');
    const Save = makeIcon('Sav');
    const LayoutDashboard = makeIcon('Dsh');
    const PieChart = makeIcon('Pie');

    // ====== React本体 ======
    const { useState, useMemo } = React;

    const RealEstateTaskManager = () => {
      const [view, setView] = useState('dashboard');
      const [selectedContract, setSelectedContract] = useState(1);
      const [showNewContract, setShowNewContract] = useState(false);
      const [showEditContract, setShowEditContract] = useState(false);
      const [editingContract, setEditingContract] = useState(null);
      const [editContractTab, setEditContractTab] = useState('basic');
      const [showTaskDetail, setShowTaskDetail] = useState(null);
      const [isEditingTask, setIsEditingTask] = useState(false);
      const [editedTask, setEditedTask] = useState(null);
      const [showPaymentDetail, setShowPaymentDetail] = useState(null);

      const [salesPeriodType, setSalesPeriodType] = useState('month');
      const [salesYear, setSalesYear] = useState(2025);
      const [salesMonth, setSalesMonth] = useState(10);

      const [currentStep, setCurrentStep] = useState(1);
      const [editStep, setEditStep] = useState(1);
      const totalSteps = 7;

      const [searchQuery, setSearchQuery] = useState('');
      const [priorityFilter, setPriorityFilter] = useState('all');
      const [typeFilter, setTypeFilter] = useState('all');
      const [statusFilter, setStatusFilter] = useState('all');
      const [dateFilter, setDateFilter] = useState('all');
      const [showFilters, setShowFilters] = useState(false);
      const [officeFilter, setOfficeFilter] = useState('all');

      // 🔧 追加：モーダル表示用 state（未定義エラーの原因）
      const [showAddOffice, setShowAddOffice] = useState(false);
      const [showAddStaff, setShowAddStaff] = useState(false);

      const [newContract, setNewContract] = useState({
        propertyType: 'マンション', address: '', propertyName: '', roomNumber: '',
        dealType: '仲介', buyerName: '', buyerKana: '', sellerName: '', sellerKana: '',
        propertyPrice: '', outstandingDebt: '', consumptionTax: '', loanUsage: false,
        loanApprovalDate: '', mortgageRemoval: false, arrears: false, demolition: false,
        renovation: false, survey: false, contractDate: '', settlementDeadline: '',
        confirmedSettlementDate: '', officeId: '', assigneeId: '',
        manualRevenue: '',
        buyerPaymentEnabled: false, buyerPaymentSplit: false,
        buyerPayments: [{ category: '仲介手数料', amount: '', dueDate: '', method: '振込', receipt: '郵送' }],
        sellerPaymentEnabled: false, sellerPaymentSplit: false,
        sellerPayments: [{ category: '仲介手数料', amount: '', dueDate: '', method: '振込', receipt: '郵送' }],
        vendor1PaymentEnabled: false,
        vendor1Payments: [{ category: '紹介料', amount: '', dueDate: '', method: '振込', receipt: '郵送' }],
        vendor2PaymentEnabled: false,
        vendor2Payments: [{ category: '紹介料', amount: '', dueDate: '', method: '振込', receipt: '郵送' }],
        vendor3PaymentEnabled: false,
        vendor3Payments: [{ category: '紹介料', amount: '', dueDate: '', method: '振込', receipt: '郵送' }],
        buyerExpenseEnabled: false,
        buyerExpenses: [{ category: '返金', amount: '', dueDate: '', accountImages: [] }],
        sellerExpenseEnabled: false,
        sellerExpenses: [{ category: '手付金', amount: '', dueDate: '', accountImages: [] }],
        vendor1ExpenseEnabled: false,
        vendor1Expenses: [{ category: '仲介手数料', amount: '', dueDate: '', accountImages: [] }],
        vendor2ExpenseEnabled: false,
        vendor2Expenses: [{ category: '仲介手数料', amount: '', dueDate: '', accountImages: [] }],
        vendor3ExpenseEnabled: false,
        vendor3Expenses: [{ category: '仲介手数料', amount: '', dueDate: '', accountImages: [] }]
      });

      const [contracts, setContracts] = useState([
        {
          id: 1, propertyType: 'マンション', address: '東京都渋谷区神宮前1-1-1',
          propertyName: 'パークマンション渋谷', roomNumber: '305', dealType: '仲介',
          buyerName: '田中太郎', buyerKana: 'タナカタロウ', sellerName: '山田次郎',
          sellerKana: 'ヤマダジロウ', propertyPrice: 50000000, outstandingDebt: 30000000,
          consumptionTax: 0, manualRevenue: 0, loanUsage: true, loanApprovalDate: '2025-11-10',
          mortgageRemoval: true, arrears: false, demolition: false, renovation: true,
          survey: false, contractDate: '2025-10-15', settlementDeadline: '2025-11-30',
          confirmedSettlementDate: '', assigneeId: 1, officeId: 1, status: '契約準備中', progress: 30,
          buyerPayments: [], sellerPayments: [], vendor1Payments: [], vendor2Payments: [], vendor3Payments: [],
          buyerExpenses: [], sellerExpenses: [], vendor1Expenses: [], vendor2Expenses: [], vendor3Expenses: []
        }
      ]);

      const [tasks, setTasks] = useState([
        { id: 1, contractId: 1, type: '入金', title: '買主から仲介手数料入金', amount: 1500000, purpose: '仲介手数料', paymentMethod: '振込', receiptDelivery: '郵送', dueDate: '2025-11-30', status: 'pending', assigneeId: 1, priority: 'high', paymentCompleted: false },
        { id: 2, contractId: 1, type: '抵当権抹消', title: '抵当権抹消事前手続き', dueDate: '2025-10-30', status: 'in-progress', assigneeId: 1, priority: 'high', paymentCompleted: false },
        { id: 3, contractId: 1, type: '買主融資管理', title: '融資承認手続き', dueDate: '2025-11-09', status: 'pending', assigneeId: 1, priority: 'high', paymentCompleted: false },
        { id: 4, contractId: 1, type: 'リフォーム管理', title: 'リフォーム手配', dueDate: '2025-10-30', status: 'pending', assigneeId: 1, priority: 'medium', paymentCompleted: false },
        { id: 5, contractId: 1, type: '収入印紙手配', title: '買主 収入印紙手配', stampAmount: 20000, dueDate: '2025-11-28', status: 'done', assigneeId: 1, priority: 'high', party: '買主', paymentCompleted: false },
        { id: 6, contractId: 1, type: '収入印紙手配', title: '売主 収入印紙手配', stampAmount: 20000, dueDate: '2025-11-28', status: 'pending', assigneeId: 1, priority: 'high', party: '売主', paymentCompleted: false }
      ]);

      // ==== 営業所・スタッフ管理（紐づけ対応） ====
      const [offices, setOffices] = useState([
        {
          id: 1,
          name: '渋谷営業所',
          address: '東京都渋谷区',
          staff: [
            { id: 1, name: '山田花子', role: '営業担当' },
            { id: 2, name: '鈴木一郎', role: '営業担当' }
          ]
        },
        {
          id: 2,
          name: '新宿営業所',
          address: '東京都新宿区',
          staff: [
            { id: 3, name: '田中次郎', role: '所長' },
            { id: 4, name: '佐藤美咲', role: '経理' }
          ]
        }
      ]);

      const [newOffice, setNewOffice] = useState({ name: '', address: '' });
      const [newStaff, setNewStaff] = useState({ name: '', role: '営業担当', officeId: null });

      // 営業所追加
      const addOffice = () => {
        if (!newOffice.name.trim() || !newOffice.address.trim()) return;
        const newId = offices.length ? Math.max(...offices.map(o => o.id)) + 1 : 1;
        setOffices([...offices, { id: newId, ...newOffice, staff: [] }]);
        setNewOffice({ name: '', address: '' });
      };

      // 営業所削除
      const removeOffice = (id) => {
        if (confirm('この営業所を削除しますか？')) {
          setOffices(offices.filter(o => o.id !== id));
        }
      };

      // スタッフ追加（営業所に紐づけ）
      const addStaff = () => {
        if (!newStaff.name.trim() || !newStaff.officeId) return;
        const updatedOffices = offices.map(o => {
          if (o.id === parseInt(newStaff.officeId)) {
            const newId = o.staff.length > 0 ? Math.max(...o.staff.map(s => s.id)) + 1 : 1;
            return { ...o, staff: [...o.staff, { id: newId, name: newStaff.name, role: newStaff.role }] };
          }
          return o;
        });
        setOffices(updatedOffices);
        setNewStaff({ name: '', role: '営業担当', officeId: null });
      };

      // スタッフ削除
      const removeStaff = (officeId
